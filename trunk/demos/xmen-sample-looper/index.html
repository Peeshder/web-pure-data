<html>
<head>
	<title>Pd.js - xmen sample looper</title>
	<script language="javascript" src="../../pd.js"></script>
	<script>
		var pd = null;
		var selection = null;
		
		function setup() {
			pd = new Pd(44100, 4410, true);
			pd.load("xmen.pd", pd.play);
			selection = document.getElementById("selection");
		}
		
		var start = 0;
		var end = 0;
		var down = false;
		
		function mousedown(ev) {
			var x = ev.pageX;
			var y = ev.pageY;
			if (x > 156 && x < 356 && y > 28 && y < 168) {
				down = true;
				start = x;
				selection.style.left = x;
				selection.style.top = 27;
				selection.style.height = 138;
				selection.style.width = 0;
				pd.send("glitch", 1);
				pd.send("loop", 0);
				pd.send("start", (x - 156) / 200 * 14818);
				pd.send("end", (x - 156) / 200 * 14818);
			}
			ev.stopPropagation();
			return false;
		}
		
		function mouseup(ev) {
			if (down) {
				selection.style.left = 0;
				selection.style.top = 0;
				selection.style.width = 0;
				selection.style.height = 0;
				down = false;
				pd.send("glitch", 0);
				pd.send("loop", 1);
			}
			ev.stopPropagation();
			return false;
		}
		
		function mousemove(ev) {
			if (down) {
				if (ev.pageX > start) {
					pd.send("start", (start - 156) / 200 * 14818);
					pd.send("end", (ev.pageX - 156) / 200 * 14818);
					selection.style.width = Math.min(ev.pageX - start, 200);
				} else {
					pd.send("start", (ev.pageX - 156) / 200 * 14818);
					pd.send("end", (start - 156) / 200 * 14818);
					selection.style.width = Math.min(start - ev.pageX, 200);
					selection.style.left = Math.max(ev.pageX, 156)
				}
			}
			ev.stopPropagation();
			return false;
		}
	</script>
	<style>
		#selection {
			border: 1px solid red;
			background: red;
			opacity: 0.5;
			position: absolute;
			left: 0px;
			top: 0px;
			width: 0px;
			height: 0px;
		}
	</style>
</head>
<body onload='return setup();'>
<div id='selection' onmousedown='return false;' onmouseup='return mouseup(event);' onmousemove='return mousemove(event);'></div>
<img src='xmen.png' onmousedown='return mousedown(event);' onmouseup='return mouseup(event);' onmousemove='return mousemove(event);'/>
</body>
</html>
